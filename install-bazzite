#!/usr/bin/env python3
import os
import subprocess
import sys
from pathlib import Path
import shutil
import zipfile

# SPDX-License-Identifier: GPL-2.0-or-later

# Define paths
BIN_NERD_DICTATION = Path.home() / ".local" / "bin" / "nerd-dictation"
BIN_PIPX_NERD_DICTATION = Path.home() / ".local" / "bin" / "pipx-nerd-dictation"
NERD_DICTATION_CONFIG = Path.home() / ".config" / "nerd-dictation" / "model"
VOSK_MODEL_URL = "https://alphacephei.com/kaldi/models/vosk-model-small-en-us-0.15.zip"

# Copy pipx-nerd-dictation
BIN_PIPX_NERD_DICTATION.parent.mkdir(parents=True, exist_ok=True)
shutil.copy("pipx-nerd-dictation", BIN_PIPX_NERD_DICTATION)

# Copy nerd-dictation
BIN_NERD_DICTATION.parent.mkdir(parents=True, exist_ok=True)
shutil.copy("nerd-dictation", BIN_NERD_DICTATION)

# Make nerd-dictation executable
os.chmod(BIN_NERD_DICTATION, 0o755)
os.chmod(BIN_PIPX_NERD_DICTATION, 0o755)

# Install pipx and vosk
subprocess.run(["brew", "install", "pipx"], check=True)
subprocess.run(["pipx", "install", "vosk"], check=True)

# Download and extract VOSK model
subprocess.run(["wget", VOSK_MODEL_URL, "-P", str(NERD_DICTATION_CONFIG.parent)], check=True)
with zipfile.ZipFile(NERD_DICTATION_CONFIG.parent / VOSK_MODEL_URL.split('/')[-1], 'r') as zip_ref:
    zip_ref.extractall(NERD_DICTATION_CONFIG.parent)

# Move extracted model to config directory
extracted_model = NERD_DICTATION_CONFIG.parent / "vosk-model-small-en-us-0.15"
NERD_DICTATION_CONFIG.parent.mkdir(parents=True, exist_ok=True)
shutil.copytree(str(extracted_model), str(NERD_DICTATION_CONFIG), dirs_exist_ok=True)

# Clean up downloaded zip and extracted model directory
os.remove(NERD_DICTATION_CONFIG.parent / VOSK_MODEL_URL.split('/')[-1])
shutil.rmtree(extracted_model)

print("Setup completed successfully.")


